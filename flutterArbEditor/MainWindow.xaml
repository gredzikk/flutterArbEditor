<Window
    x:Class="flutterArbEditor.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:flutterArbEditor"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Flutter ARB Editor"
    Width="1200"
    Height="800"
    AllowDrop="True"
    Drop="Window_Drop"
    FontFamily="Segoe UI"
    mc:Ignorable="d">

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Toolbar  -->
        <ToolBar Grid.Row="0" Margin="0,0,0,12">
            <Button
                Command="{Binding AddFilesCommand}"
                Content="🗂️ Add Files"
                Style="{StaticResource PrimaryButton}" />
            <Button
                Margin="8,0"
                Command="{Binding SaveAllCommand}"
                Content="💾 Save All"
                Style="{StaticResource SuccessButton}" />
            <Separator />
            <Button
                Margin="8,0"
                Command="{Binding SortKeysCommand}"
                Content="🔤 Sort Keys"
                Style="{StaticResource PrimaryButton}" />
            <Button
                Margin="8,0"
                Command="{Binding SyncMissingKeysCommand}"
                Content="🔄 Sync Missing Keys"
                Style="{StaticResource WarningButton}" />
            <Button
                Command="{Binding RunFlutterGenCommand}"
                Content="🚀 Flutter gen-l10n"
                Style="{StaticResource AccentButton}" />
        </ToolBar>

        <!--  Main Content  -->
        <Grid Grid.Row="1" Margin="0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="450" />
                <ColumnDefinition Width="8" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Translation Keys  -->
            <GroupBox
                Grid.Column="0"
                Header="🔑 Translation Keys"
                Style="{StaticResource CardGroupBox}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Add New Key Section  -->
                    <Border
                        Grid.Row="0"
                        Margin="0,0,0,12"
                        Padding="12"
                        Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="✨ Add New Key:" />
                            <TextBox Margin="0,0,0,8" Text="{Binding NewKeyName, UpdateSourceTrigger=PropertyChanged}" />
                            <StackPanel Orientation="Horizontal">
                                <Button
                                    Margin="0,0,8,0"
                                    Command="{Binding AddNewKeyCommand}"
                                    Content="➕ Add Key"
                                    Style="{StaticResource SuccessButton}" />
                                <Button
                                    Command="{Binding RemoveKeyCommand}"
                                    Content="❌ Remove Key"
                                    Style="{StaticResource DangerButton}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Grouped Keys TreeView  -->
                    <TreeView Grid.Row="1" ItemsSource="{Binding GroupedTranslationKeys}">
                        <TreeView.Resources>
                            <!--  Style for top-level items (TranslationKeyGroup)  -->
                            <Style x:Key="GroupStyle" TargetType="{x:Type TreeViewItem}">
                                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                <Setter Property="FontWeight" Value="SemiBold" />
                            </Style>

                            <!--  Style for child items (TranslationKeyViewModel)  -->
                            <Style x:Key="KeyStyle" TargetType="{x:Type TreeViewItem}">
                                <Setter Property="FontWeight" Value="Normal" />
                            </Style>
                        </TreeView.Resources>

                        <TreeView.ItemContainerStyle>
                            <Style BasedOn="{StaticResource GroupStyle}" TargetType="TreeViewItem" />
                        </TreeView.ItemContainerStyle>

                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Keys}">
                                <HierarchicalDataTemplate.ItemContainerStyle>
                                    <Style BasedOn="{StaticResource KeyStyle}" TargetType="TreeViewItem" />
                                </HierarchicalDataTemplate.ItemContainerStyle>

                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="📁 " />
                                    <TextBlock FontWeight="Bold" Text="{Binding GroupName}" />
                                    <TextBlock
                                        Margin="4,0,0,0"
                                        FontSize="11"
                                        Foreground="Gray"
                                        Text="{Binding Keys.Count, StringFormat=' ({0} keys)'}" />
                                </StackPanel>

                                <HierarchicalDataTemplate.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Margin="1"
                                            Padding="4,2"
                                            CornerRadius="3">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsMissingInSomeFiles}" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource MissingKeyBrush}" />
                                                            <Setter Property="BorderBrush" Value="{StaticResource MissingKeyBorderBrush}" />
                                                            <Setter Property="BorderThickness" Value="1" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <Border.InputBindings>
                                                <MouseBinding
                                                    Command="{Binding DataContext.SelectKeyCommand, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                                    CommandParameter="{Binding}"
                                                    MouseAction="LeftClick" />
                                            </Border.InputBindings>
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock
                                                        FontFamily="Consolas"
                                                        FontSize="12"
                                                        Text="{Binding Key}" />
                                                    <TextBlock
                                                        Margin="4,0,0,0"
                                                        Text="⚠️"
                                                        ToolTip="Missing in some files">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsMissingInSomeFiles}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>
                                                <TextBlock
                                                    Margin="0,2,0,0"
                                                    FontSize="10"
                                                    Foreground="Gray"
                                                    Text="{Binding StatusText}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsMissingInSomeFiles}" Value="True">
                                                                    <Setter Property="Foreground" Value="{StaticResource WarningBrush}" />
                                                                    <Setter Property="FontWeight" Value="SemiBold" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </HierarchicalDataTemplate.ItemTemplate>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Grid>
            </GroupBox>

            <GridSplitter Grid.Column="1" />

            <!--  Translation Editor  -->
            <GroupBox
                Grid.Column="2"
                Header="✏️ Translations"
                Style="{StaticResource CardGroupBox}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding CurrentTranslations}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,0,0,16"
                                    Padding="16"
                                    Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <Border
                                            Grid.Row="0"
                                            Margin="0,0,0,12"
                                            Padding="8,4"
                                            Background="{StaticResource PrimaryBrush}"
                                            CornerRadius="4">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="16"
                                                    Text="🌍 " />
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="14"
                                                    FontWeight="SemiBold"
                                                    Foreground="White"
                                                    Text="{Binding LanguageCode}" />
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    Foreground="White"
                                                    Text=" - " />
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="12"
                                                    Foreground="White"
                                                    Text="{Binding FileName}" />
                                            </StackPanel>
                                        </Border>

                                        <TextBox
                                            Grid.Row="1"
                                            MinHeight="80"
                                            Margin="0,0,0,12"
                                            AcceptsReturn="True"
                                            FontSize="14"
                                            Text="{Binding Translation, UpdateSourceTrigger=PropertyChanged}"
                                            TextWrapping="Wrap" />

                                        <Expander Grid.Row="2" Header="⚙️ Placeholders (JSON)">
                                            <TextBox
                                                MinHeight="100"
                                                Margin="0,8,0,0"
                                                AcceptsReturn="True"
                                                FontFamily="Consolas"
                                                FontSize="12"
                                                Text="{Binding PlaceholderJson, UpdateSourceTrigger=PropertyChanged}"
                                                TextWrapping="Wrap" />
                                        </Expander>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </GroupBox>
        </Grid>


        <!--  Status Bar  -->
        <StatusBar Grid.Row="3" Margin="0,8,0,0">
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="📁 " />
                    <TextBlock FontWeight="SemiBold" Text="{Binding FlutterProjectPath, StringFormat='Flutter Project: {0}'}" />
                </StackPanel>
            </StatusBarItem>
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="🔑 " />
                    <TextBlock FontWeight="SemiBold" Text="{Binding TranslationKeys.Count, StringFormat='Keys: {0}'}" />
                </StackPanel>
            </StatusBarItem>
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="📄 " />
                    <TextBlock FontWeight="SemiBold" Text="{Binding ArbFiles.Count, StringFormat='Files: {0}'}" />
                </StackPanel>
            </StatusBarItem>
            <StatusBarItem>
                <TextBlock
                    FontSize="12"
                    FontWeight="SemiBold"
                    Text="{Binding LoadedLanguagesText}" />
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>